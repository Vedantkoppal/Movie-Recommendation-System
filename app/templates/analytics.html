{% extends "base.html" %}
{% block content %}

<!-- ‚úÖ Full-Width Background -->
<div class="w-full min-h-screen bg-gray-900 text-white flex flex-col items-center p-4">

    <!-- ‚úÖ Metrics Section -->
    <div class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold">Total Visitors</h2>
            <p class="text-2xl font-bold" id="total">0</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold">Unique Visitors</h2>
            <p class="text-2xl font-bold" id="unique">0</p>
        </div>
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold">Active Users</h2>
            <p class="text-2xl font-bold" id="active">0</p>
        </div>
    </div>

    <!-- ‚úÖ Chart Section -->
    <div class="mt-8 w-full max-w-4xl bg-gray-800 p-6 rounded-lg shadow-lg">
        <h3 class="text-xl text-center text-gray-300 mb-4">User Activity (Daily & Monthly)</h3>
        <div class="relative w-full" style="height: 300px;">
            <canvas id="visitorChart"></canvas>
        </div>
    </div>

</div>

<!-- ‚úÖ Scripts -->
<script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const socket = io();

// ‚úÖ Debugging: Log received data
socket.on("update_stats", (data) => {
    console.log("üì° Received data:", data);
    
    // ‚úÖ Update Metrics
    document.getElementById('total').innerText = data.total_visitors;
    document.getElementById('unique').innerText = data.total_unique_visitors;
    document.getElementById('active').innerText = data.current_active_visitors;

    // ‚úÖ Update Chart
    if (data.daily_data && data.monthly_data) {
        updateChart(data.daily_data, data.monthly_data);
    }
});

// ‚úÖ Create Chart.js Instance
const ctx = document.getElementById('visitorChart').getContext('2d');
const visitorChart = new Chart(ctx, {
    type: "line",
    data: {
        labels: [],
        datasets: [
            { label: "Active Users", data: [], borderColor: "red", fill: false },
            { label: "Unique Users", data: [], borderColor: "blue", fill: false },
            { label: "Total Users", data: [], borderColor: "green", fill: false }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { title: { display: true, text: "Date" } },
            y: { beginAtZero: true, title: { display: true, text: "Users" } }
        }
    }
});

// ‚úÖ Function to Update Chart
function updateChart(dailyData, monthlyData) {
    if (!dailyData || !dailyData.dates || dailyData.dates.length === 0) {
        console.warn("‚ö†Ô∏è No valid data received for chart.");
        return;
    }
    
    visitorChart.data.labels = dailyData.dates;
    visitorChart.data.datasets[0].data = dailyData.active_users;
    visitorChart.data.datasets[1].data = dailyData.unique_users;
    visitorChart.data.datasets[2].data = dailyData.total_users;
    visitorChart.update();
}
</script>

{% endblock %}


